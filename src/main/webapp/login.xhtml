<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	template="/template/main.xhtml">

	<ui:define name="body">
<div id="fb-root"></div>
<script>
	/*
  window.fbAsyncInit = function() {
  FB.init({
    appId      : '548688288560242',
    status     : true, // check login status
    cookie     : true, // enable cookies to allow the server to access the session
    xfbml      : true  // parse XFBML
  });
  */

  /*
  // Here we subscribe to the auth.authResponseChange JavaScript event. This event is fired
  // for any authentication related change, such as login, logout or session refresh. This means that
  // whenever someone who was previously logged out tries to log in again, the correct case below 
  // will be handled. 
  FB.Event.subscribe('auth.authResponseChange', function(response) {
    // Here we specify what we do with the response anytime this event occurs. 
    if (response.status === 'connected') {
      // The response object is returned with a status field that lets the app know the current
      // login status of the person. In this case, we're handling the situation where they 
      // have logged in to the app.
      testAPI();
    } else if (response.status === 'not_authorized') {
      // In this case, the person is logged into Facebook, but not into the app, so we call
      // FB.login() to prompt them to do so. 
      // In real-life usage, you wouldn't want to immediately prompt someone to login 
      // like this, for two reasons:
      // (1) JavaScript created popup windows are blocked by most browsers unless they 
      // result from direct interaction from people using the app (such as a mouse click)
      // (2) it is a bad experience to be continually prompted to login upon page load.
      FB.login();
    } else {
      // In this case, the person is not logged into Facebook, so we call the login() 
      // function to prompt them to do so. Note that at this stage there is no indication
      // of whether they are logged into the app. If they aren't then they'll see the Login
      // dialog right after they log in to Facebook. 
      // The same caveats as above apply to the FB.login() call here.
      FB.login();
    }
  });*/
  //};

  // Load the SDK asynchronously
  /*
  (function(d){
   var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
   if (d.getElementById(id)) {return;}
   js = d.createElement('script'); js.id = id; js.async = true;
   js.src = "//connect.facebook.net/en_US/all.js";
   ref.parentNode.insertBefore(js, ref);
  }(document));*/

  // Here we run a very simple test of the Graph API after login is successful. 
  // This testAPI() function is only called in those cases. 
  function testAPI() {
    console.log('Welcome!  Fetching your information.... ');
    FB.api('/me', function(response) {
      console.log('Good to see you, ' + response.name + '.');
    });
  }
</script>

<!--
  Below we include the Login Button social plugin. This button uses the JavaScript SDK to
  present a graphical Login button that triggers the FB.login() function when clicked. -->

<!--
<fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
-->

		<div class="container" style="margin-top: 70px;">
			<div class="col-md-6 col-md-offset-3">
				<div class="panel" style="margin-bottom: 0px;">
					<div class="panel-body text-center">
						<button id="google-login" type="button" class="btn btn-danger" style="width: 190px;"><img src="images/google.png"/> <strong>Entrar com Google</strong></button>
					  <button id="facebook-login" type="button" class="btn btn-primary" style="width: 190px;"><img src="images/facebook.png"/> <strong>Entrar com Facebook</strong></button>
					</div>
				</div>
				<p class="seperator">ou</p>
				<div class="panel panel-default">
					<div class="panel-body">
						<form id="form-login" class="form-horizontal" role="form">
							<p>
								<label for="email">E-mail</label>
								<input id="email" type="text" class="form-control input-lg" />
								<div id="email-message" class="label label-danger" />
							</p>
							<p>
								<label for="password">Senha</label>
								<input id="password" type="password" class="form-control input-lg" />
								<div id="password-message" class="label label-danger" />
							</p>
							<p>
								<button id="login" class="btn btn-lg btn-success " type="button">Entrar</button>
							</p>
							<div id="message" class="label label-danger" />
						</form>
					</div>
					<div class="panel-footer text-center">
						<p>
							<a href="register.jsf" class="register-link">Precisa de uma conta? <strong>Registre-se aqui</strong></a> <br /> 
							<a href="recuperar-senha.jsf" class="password-link"><small>Esqueceu sua senha?</small></a>
						</p>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="modal" tabindex="-1" role="dialog">
			<div style="height:200px">
      			<span id="spin" style="position: absolute; display: block; top: 50%;left: 50%;"></span>
    		</div>
		</div>

		<script src="api/entity/Credentials.js" />

		<h:outputScript name="js/facebook-all.js" />
		<h:outputScript name="js/client-plusone.js" />
		<h:outputScript name="js/jquery-1.10.2.js" />
		<h:outputScript name="js/bootstrap.js" />
		<h:outputScript name="js/spin.js" />
		<h:outputScript name="js/client/auth.js" />
		<h:outputScript name="js/client/facebook-auth.js" />
		<h:outputScript name="js/client/google-auth.js" />

		<script>
			function onLoginSuccessful(data){
				window.location = "index.jsf";
			}
	
			function onLoginFailed(data){
				switch (data.status) {
					case 412: 
						$.each(data.responseJSON, function(index, value) {
							console.log(value.property + ":" + value.message);
							$("#" + value.property + "-message").html(value.message);
						});
						break;

					case 401: 
						$("#message").html("Usuário ou senha inválidos.");
						break;
					case 403:
						$("#message").html(data.responseText);
						break;
				}
			}

			function onFacebookLoginSuccessful(data){
				FB.logout();
				window.location = "index.jsf";
			}

			function onFacebookLoginFailed(data){
				console.log("login facebook failed");
			}

			function onGoogleLoginSuccessful(data){
				gapi.auth.signOut();
				window.location = "index.jsf";
			}

			function onGoogleLoginFailed(data){
				console.log("login google failed");
			}

			$(function(){
				$("#login").click(function(){
					$("[id$='message']").html("");
					
					var credentials = new Credentials();
					credentials.email = $("#email").val();
					credentials.password = $("#password").val();

					var client = new AuthClient();
					client.login(credentials, onLoginSuccessful, onLoginFailed);
				});
		
				$(document).keypress(function(e) {
					if(e.which == 13) {
						var credentials = new Credentials();
						credentials.email = $("#email").val();
						credentials.password = $("#password").val();

						var client = new AuthClient();
						client.login(credentials, onLoginSuccessful, onLoginFailed);
					}
				});

				$("#facebook-login").click(function(){
					FB.init({
						appId	: '548688288560242',
						status	: true, // check login status
						cookie	: true, // enable cookies to allow the server to access the session
						xfbml	: true  // parse XFBML
					});

					FB.login(onFacebookSignIn, {scope: 'email,user_birthday'});
				});

				$("#google-login").click(function(){
					$('#modal').modal('show');
					var opts = {
							  lines: 11, // The number of lines to draw
							  length: 19, // The length of each line
							  width: 10, // The line thickness
							  radius: 22, // The radius of the inner circle
							  corners: 1, // Corner roundness (0..1)
							  rotate: 0, // The rotation offset
							  direction: 1, // 1: clockwise, -1: counterclockwise
							  color: '#fff', // #rgb or #rrggbb or array of colors
							  speed: 1, // Rounds per second
							  trail: 50, // Afterglow percentage
							  shadow: false, // Whether to render a shadow
							  hwaccel: true, // Whether to use hardware acceleration
							  className: 'spinner', // The CSS class to assign to the spinner
							  zIndex: 2e9, // The z-index (defaults to 2000000000)
							  top: 'auto', // Top position relative to parent in px
							  left: 'auto' // Left position relative to parent in px
							};
					var target = document.getElementById('spin');
					var spinner = new Spinner(opts).spin(target);

					gapi.auth.signIn({
						'clientid': '611475192580-k33ghah4orsl7d4r1r6qml5i4rtgnnrd.apps.googleusercontent.com',
						'cookiepolicy': 'single_host_origin',
						'callback': 'onGoogleSignIn',
						'scope': 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile' 
					});
				});
			});

			function onFacebookSignIn(response) {
				if (response.authResponse) {
					$("#form-login input").attr("disabled", true);

					var client = new FacebookAuthClient();
					client.login(response.authResponse.accessToken, onFacebookLoginSuccessful, onFacebookLoginFailed);

					$("#form-login input").attr("disabled", false);
			    } else {
					console.log("nada!!!");
			    }
			}

			function onGoogleSignIn(authResult) {
				if (authResult['access_token']) {
					$("#form-login input").attr("disabled", true);
					
					var client = new GoogleAuthClient();
					client.login(authResult.code, onGoogleLoginSuccessful, onGoogleLoginFailed);

					$("#form-login input").attr("disabled", false);

				} else if (authResult['error']) {
					console.log("nada!!!");
				}
			}
		</script>
	</ui:define>
</ui:composition>
